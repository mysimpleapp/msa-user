<link rel="import" href="/msa/msa.html"></link>
<style>
	msa-user-login {
		flex: 1;
		display: flex;
	}
	msa-user-login .logged, msa-user-login .unlogged {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: center;
		text-align: center;
		padding: 10px;
	}
	msa-user-login div {
		padding: 3px;
	}
	msa-user-login .title {
		font-weight: bold;
		font-size: 20px;
	}
</style>
<template id="msa-user-login">
	<div class="unlogged">
		<div class="title"></div>
		<div class="text"></div>
		<div><input type=text name="username" placeholder="username"></div>
		<div><input type=password name="pass" placeholder="password"></div>
		<div><button class="login">Connexion</button></div>
	</div>
	<div class="logged">
		<div class="title"></div>
		<div class="text"></div>
		<div>Vous êtes connecté en tant que <b class="name"></b></div>
		<div><button class="logout">Déconnexion</button></div>
	</div>
</template>
<script>
(function() {

	// methods
	var loginMethods = {}
	loginMethods.init = function() {
		var user = Msa.user
		this.Q(".unlogged").style.display = user ? "none" : ""
		this.Q(".logged").style.display = user ? "" : "none"
		if(user) this.Q(".logged .name").textContent = user.name
		this.sync()
	}
	loginMethods.sync = function() {
		// read attributes
		var defaultTitle = defArg(
			this.getAttribute("title"),
			this.hasAttribute("unauthorized") ? "Unauthorized !" : null)
		var defaultText = defArg(
			this.getAttribute("text"),
			this.hasAttribute("unauthorized") ? "Please login with a user with valid privileges." : null)
		var loggedTitle = defArg(
			this.getAttribute("logged-title"),
			defaultTitle)
		var loggedText = defArg(
			this.getAttribute("logged-text"),
			defaultText)
		var unloggedTitle = defArg(
			this.getAttribute("unlogged-title"),
			defaultTitle,
			"Log-in")
		var unloggedText = defArg(
			this.getAttribute("unlogged-text"),
			defaultText)

		// sync titles & texts
		syncText(this.Q(".logged .title"), loggedTitle)
		syncText(this.Q(".logged .text"), loggedText)
		syncText(this.Q(".unlogged .title"), unloggedTitle)
		syncText(this.Q(".unlogged .text"), unloggedText)
	}
	var syncText = function(el, val) {
		el.style.display = val ? "" : "none"
		el.textContent = val ? val : ""
	}

	// actions
	var loginActions = []
	loginActions.push({el:"button.login", evt:"click", act:function() {
		var name = this.Q(".unlogged input[name=username]").value,
			pass = this.Q(".unlogged input[name=pass]").value
		Msa.post('/user/login',
			{ header:{ Authorization: "Basic "+name+":"+pass }},
			function(user){
				if(user) location.reload()
			}
		)
	}})
	loginActions.push({el:"button.logout", evt:"click", act:function() {
		Msa.post('/user/logout', function() {
			location.reload()
		})
	}})

	// register elements
	Msa.registerElement("msa-user-login", {
		template: "#msa-user-login",
		oncreate: function() {
			this.Q = Msa.Q
			Object.assign(this, loginMethods)
			Msa.addActions(this, loginActions)
		},
		onattach: function() {
			this.init()
		},
		onchange: function() {
			this.sync()
		}
	})

	// various
	var defArg = function() {
		for(var i=0, len=arguments.length; i<len; ++i) {
			var arg = arguments[i]
			if(arg!==undefined && arg!==null) return arg
		}
	}
})()
</script>
